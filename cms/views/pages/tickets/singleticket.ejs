<html>

<%- include ('../../templates/heading/htmlhead') -%>
<%- include ('../../templates/heading/alertmanager') -%>
<%- include ('../../templates/heading/standard_header') -%>
<%- include ('../../templates/nav') -%>



<br>
<br>

<body>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
	<div class="container">
		<div class="card">
			<div class="card-body">
				<h3 class="card-title">
					<%= ticket.title %>
				</h3>
				<p class="card-text">
					<%= ticket.body %>
				</p>
			</div>
		</div>
	</div>
</body>

<% if(admin) { %>

<br>
<br>

 <div class="container">
  <div class="content">
    <div class="mb-3 card">
      <div class="card-header">
        <div class="row">
          <div class="col">
            <h5 id="ticket_creator" class="mb-2">
              <%= author.firstName %><%= author.lastName %>
              <!-- needs to send the user id with this \/ -->
              <a id="ticket_email" href="/profile"> <%= author.email %> </a>
            </h5>
            <!-- <button class = "btn btn-sm">
              //Add note to ticket
            </button> -->
          </div>
        </div>
      </div>
    </div>
    <br>
    <br>
    <div class="card">
      <div class="bg-light card-header">
      	<h4 class="mb-0">
          Ticket information
	      </h4>
         <br>
         <div class="border-top p-0 card-body">
          <div class="align-items-center border-bottom ppy-2 px-3 no-gutters row">
            <div class="pr-3 col-md-auto">
              <p id="ticket_id" class="badge badge-soft-success-badge-pill"> <%= ticket.id %> </p>
            </div>
            <div class="pr-3 col-md-auto">
              <code id="status_code"><%= ticket.status %>
              </code>
            </div>
            <div class="pr-3 col-md-auto">
              <div class="pr-3 col-md-auto">
              	<% if(assigned) { %>
	              <span id="assigned_id" class="badge badge-soft-success-badge-pill"> <%= assigned.firstName %>  <%= assigned.lastName %>
	              </span>
              	<% }else{ %>
              		<span id="assigned_id" class="badge badge-soft-success-badge-pill"> Unassigned
	              </span>
	            <% } %>
              </div>
            </div>
            <div id="ticket_title" class="mt-1 mt-md-0 col-md">
              <%= ticket.title %>
            </div>
            <div class="col-md-auto">
              <br>
              <p id="ticket_body" class="mb-0">
                <%= ticket.body %>
              </p>
            </div>
          </div>
      </div>
		</div>
	</div>

	<div class="card">
  	<div class="container">
    	<label for="assign_change"> Change Assigned </label>
      <input id="assign_change"> </input>
      <div class="float-right">
        <button id="assigned" class="btn btn-outline-primary btn-sm"> Edit </button>
      </div>
    </div>
    <div class="container">
    	<!-- <label for="status_change"> Change Ticket Status </label> -->
    	<!-- <input id="status_change"> </input> -->
			<label for="statusChange_menuButton"> Change Ticket Status </label>
			<div class="dropdown">
  			<button class="btn btn-primary dropdown-toggle" type="button" id="statusChange_menuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><%= ticket.status %></button>
  			<div class="dropdown-menu" aria-labelledby="statusChange_menuButton">
					<% statuses.forEach(function(status) { %>
    			<li> <a class="dropdown-item" href="#"><%=status%></a></li>
					<% }) %>
  			</div>
			</div>
    	<div class="float-right">
        <button id="status" class="btn btn-outline-primary btn-sm"> Edit </button>
      </div>
    </div>
    </div>
	 </div>
</div>

<% } %>

<br>
<br>
<%- include ('../../templates/footer') -%>
</body>
</html>

<% if(admin) { %>

<script type = "text/javascript">

jQuery(document).ready(function($){

	$(function(){
		$(".dropdown-menu li a").click(function(){
			$("#statusChange_menuButton").text($(this).text());
			$("#statusChange_menuButton").val($(this).text());
		});
	});

  jQuery('#status').click(function() {
    var info = {
        ticket_id: <%= ticket.id %>,
				status: jQuery('#statusChange_menuButton').text()
      }
		console.log(info.status);
    jQuery.ajax({
        url: '/ticket/status',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(info),
        success: function(res) {
		      window.location.replace(res.url);
        },
        error: function(res, err) {
          console.log('POST error');
        }
      });
    })
    jQuery('#assigned').click(function() {
      var assigned = {
          ticket_id: jQuery('#ticket_id').val(),
          user_id: jQuery('#assign_change').val()
      }
      console.log(assigned);
      jQuery.ajax({
          url: '/ticket/assigned',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(assigned),
          success: function(data) {
            console.log('ASSIGN POST success');
          },
          error: function(req, err) {
            console.log('POST error');
          }
        });
      })
});

</script>
<% } %>
